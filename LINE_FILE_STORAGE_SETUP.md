# LINE æª”æ¡ˆå„²å­˜åŠŸèƒ½è¨­å®šæŒ‡å—

## å•é¡Œæè¿°

å·è¼ LINE AI æ©Ÿå™¨äººæœ‰ç¢ºå¯¦è¨˜éŒ„ç¾¤çµ„è¨Šæ¯ï¼Œä½†**æ²’æœ‰å¦‚å¯¦å„²å­˜åœ–ç‰‡ã€æª”æ¡ˆã€ZIP æª”ç­‰é™„ä»¶**ã€‚

## è§£æ±ºæ–¹æ¡ˆ

å·²å®Œæˆä»¥ä¸‹æ”¹é€²ï¼š

### 1. å¢å¼·æª”æ¡ˆä¸‹è¼‰åŠŸèƒ½ âœ…

- æ”¯æ´**æ‰€æœ‰å¸¸è¦‹æª”æ¡ˆé¡å‹**ï¼š
  - ğŸ“· åœ–ç‰‡ï¼šJPG, PNG, GIF, WebP, BMP
  - ğŸ¥ å½±ç‰‡ï¼šMP4, MOV, AVI
  - ğŸµ éŸ³è¨Šï¼šMP3, M4A, WAV
  - ğŸ“„ æ–‡ä»¶ï¼šPDF, Word, Excel, PowerPoint
  - ğŸ“¦ å£“ç¸®æª”ï¼š**ZIP, RAR, 7Z, GZ**
  - ğŸ“ å…¶ä»–ï¼šTXT, JSON, XML

### 2. è©³ç´°éŒ¯èª¤æ—¥èªŒ âœ…

- Webhook API ç¾åœ¨æœƒè¼¸å‡ºè©³ç´°çš„æª”æ¡ˆä¸‹è¼‰æµç¨‹æ—¥èªŒ
- æ¯å€‹æ­¥é©Ÿéƒ½æœ‰ emoji æ¨™è¨˜ï¼Œæ–¹ä¾¿è¿½è¹¤
- éŒ¯èª¤è¨Šæ¯æ›´è©³ç´°ï¼ŒåŒ…å« HTTP ç‹€æ…‹ç¢¼ã€éŒ¯èª¤æç¤º

### 3. Storage è¨ºæ–·å·¥å…· âœ…

- é é¢ï¼š`http://localhost:3000/storage-check`
- åŠŸèƒ½ï¼š
  - âœ… è‡ªå‹•æª¢æŸ¥ Supabase Storage è¨­å®šæ˜¯å¦æ­£ç¢º
  - âœ… æª¢æŸ¥ `chat-files` bucket æ˜¯å¦å­˜åœ¨
  - âœ… æ¸¬è©¦ä¸Šå‚³/è®€å–æ¬Šé™
  - âœ… æä¾›ä¿®å¾©å»ºè­°

### 4. æª”æ¡ˆå›æº¯åŠŸèƒ½ âœ…

- è£œä¸‹è¼‰ä¹‹å‰æ²’æœ‰æˆåŠŸå„²å­˜çš„æª”æ¡ˆ
- æ”¯æ´æŒ‡å®šç¾¤çµ„æˆ–å…¨åŸŸå›æº¯
- LINE æª”æ¡ˆé€šå¸¸ä¿ç•™ **7 å¤©**ï¼ŒéæœŸçš„æœƒè‡ªå‹•è·³é
- é¡¯ç¤ºè©³ç´°çµ±è¨ˆï¼šæˆåŠŸ/å¤±æ•—/éæœŸæ•¸é‡

---

## è¨­å®šæ­¥é©Ÿ

### Step 1: æª¢æŸ¥ Supabase Storage è¨­å®š

1. å‰å¾€ [Supabase Dashboard](https://supabase.com/dashboard)
2. é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ
3. å·¦å´é¸å–®é»é¸ **Storage**
4. æª¢æŸ¥æ˜¯å¦æœ‰ `chat-files` bucket

#### å¦‚æœ bucket ä¸å­˜åœ¨ï¼š

1. é»é¸ **New bucket**
2. è¼¸å…¥åç¨±ï¼š`chat-files`
3. âœ… å‹¾é¸ **Public bucket**
4. é»é¸ **Create bucket**

#### è¨­å®š RLS æ”¿ç­–ï¼ˆRow Level Securityï¼‰

1. é€²å…¥ `chat-files` bucket
2. é»é¸ **Policies** é ç±¤
3. é»é¸ **New Policy**
4. é¸æ“‡ **For full customization**

**æ”¿ç­– 1 - å…è¨±ä¸Šå‚³**ï¼š
```sql
CREATE POLICY "Allow uploads for authenticated users"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'chat-files');
```

**æ”¿ç­– 2 - å…è¨±è®€å–**ï¼ˆå¦‚æœ bucket æ˜¯ public å¯ä»¥è·³éï¼‰ï¼š
```sql
CREATE POLICY "Allow public read access"
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'chat-files');
```

**è‡¨æ™‚æ¸¬è©¦ç”¨æ”¿ç­–**ï¼ˆä¸æ¨è–¦ç”¨æ–¼æ­£å¼ç’°å¢ƒï¼‰ï¼š
```sql
-- å…è¨±æ‰€æœ‰äººä¸Šå‚³ï¼ˆæ¸¬è©¦ç”¨ï¼‰
CREATE POLICY "Allow all uploads"
ON storage.objects FOR INSERT
TO public
WITH CHECK (bucket_id = 'chat-files');
```

---

### Step 2: åŸ·è¡Œè¨ºæ–·å·¥å…·

1. å‰å¾€ `http://localhost:3000/storage-check`
2. é»é¸ **ã€ŒğŸ”„ é‡æ–°æª¢æŸ¥ã€**
3. æŸ¥çœ‹è¨ºæ–·çµæœï¼š
   - âœ… Supabase é€£ç·š
   - âœ… chat-files bucket å­˜åœ¨
   - âœ… Bucket è¨­ç‚ºå…¬é–‹
   - âœ… å¯ä»¥ä¸Šå‚³æª”æ¡ˆ
   - âœ… å¯ä»¥è®€å–æª”æ¡ˆ

#### å¦‚æœå‡ºç¾éŒ¯èª¤ï¼š

- **âŒ chat-files bucket ä¸å­˜åœ¨** â†’ å›åˆ° Step 1 å»ºç«‹ bucket
- **âŒ ä¸Šå‚³æ¸¬è©¦å¤±æ•—: new row violates row-level security** â†’ éœ€è¦è¨­å®š RLS æ”¿ç­–
- **âŒ Bucket ä¸æ˜¯å…¬é–‹çš„** â†’ åˆ° Storage â†’ chat-files â†’ Settings â†’ å‹¾é¸ Public

---

### Step 3: å›æº¯ä¸‹è¼‰éºæ¼çš„æª”æ¡ˆ

**é‡è¦**ï¼šLINE æª”æ¡ˆé€šå¸¸åªä¿ç•™ **7 å¤©**ï¼ŒéæœŸçš„æª”æ¡ˆç„¡æ³•è£œä¸‹è¼‰ã€‚

1. ç¢ºèª Storage è¨­å®šæ­£å¸¸ï¼ˆè¨ºæ–·å·¥å…·é¡¯ç¤ºå…¨ç¶  âœ…ï¼‰
2. é»é¸ **ã€ŒğŸ“¥ å›æº¯ä¸‹è¼‰éºæ¼æª”æ¡ˆã€**
3. ç¢ºèªæç¤ºè¨Šæ¯
4. ç­‰å¾…è™•ç†å®Œæˆï¼ˆå¯èƒ½éœ€è¦å¹¾åˆ†é˜ï¼‰
5. æŸ¥çœ‹çµæœçµ±è¨ˆï¼š
   - **æ‰¾åˆ°çš„è¨Šæ¯** - æœ‰å¤šå°‘å‰‡æª”æ¡ˆè¨Šæ¯æ²’æœ‰ file_url
   - **æˆåŠŸä¸‹è¼‰** - æˆåŠŸè£œä¸‹è¼‰çš„æ•¸é‡
   - **æª”æ¡ˆå·²éæœŸ** - LINE å·²åˆªé™¤çš„æª”æ¡ˆï¼ˆé€šå¸¸ >7 å¤©ï¼‰
   - **ä¸‹è¼‰å¤±æ•—** - å…¶ä»–éŒ¯èª¤

---

## é©—è­‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸

### æ–¹æ³• 1: æŸ¥çœ‹ä¼ºæœå™¨æ—¥èªŒ

åœ¨é–‹ç™¼ç’°å¢ƒåŸ·è¡Œ `npm run dev`ï¼Œç„¶å¾Œåˆ° LINE ç¾¤çµ„å‚³é€ä¸€å€‹æª”æ¡ˆï¼ˆåœ–ç‰‡ã€ZIP ç­‰ï¼‰ã€‚

æŸ¥çœ‹çµ‚ç«¯æ©Ÿè¼¸å‡ºï¼Œæ‡‰è©²æœƒçœ‹åˆ°ï¼š

```
ğŸ“¥ é–‹å§‹ä¸‹è¼‰æª”æ¡ˆ: type=image, id=xxx, fileName=xxx
ğŸŒ ä¸‹è¼‰ URL: https://api-data.line.me/v2/bot/message/xxx/content
ğŸ“¦ æ”¶åˆ°æª”æ¡ˆ: type=image/jpeg, size=12345 bytes
ğŸ’¾ å·²è®€å–æª”æ¡ˆåˆ°è¨˜æ†¶é«”: 12345 bytes
ğŸ“‚ æº–å‚™ä¸Šå‚³åˆ° Storage: path=chat/Cxxx/xxx.jpg
âœ… Storage ä¸Šå‚³æˆåŠŸ: chat/Cxxx/xxx.jpg
ğŸ”— å…¬é–‹ URL: https://xxx.supabase.co/storage/v1/object/public/chat-files/chat/Cxxx/xxx.jpg
âœ… æª”æ¡ˆä¸‹è¼‰å®Œæˆ
```

### æ–¹æ³• 2: æª¢æŸ¥è³‡æ–™åº«

åœ¨ Supabase Dashboard â†’ Table Editor â†’ `line_messages`ï¼ŒæŸ¥çœ‹æœ€æ–°çš„è¨Šæ¯è¨˜éŒ„ï¼š

- `message_type` æ¬„ä½æ‡‰è©²æ˜¯ `image`, `video`, `audio`, `file`
- `file_url` æ¬„ä½æ‡‰è©²æœ‰å€¼ï¼ˆå…¬é–‹ URLï¼‰
- `file_name` æ¬„ä½æ‡‰è©²æœ‰æª”æ¡ˆåç¨±
- `file_size` æ¬„ä½æ‡‰è©²æœ‰æª”æ¡ˆå¤§å°

### æ–¹æ³• 3: æª¢æŸ¥ Storage

åœ¨ Supabase Dashboard â†’ Storage â†’ `chat-files` â†’ `chat/[ç¾¤çµ„ID]`ï¼Œæ‡‰è©²å¯ä»¥çœ‹åˆ°ä¸Šå‚³çš„æª”æ¡ˆã€‚

---

## å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼æœ‰äº›æª”æ¡ˆé¡¯ç¤ºã€Œå·²éæœŸã€ï¼Ÿ

**A**: LINE çš„æª”æ¡ˆåªä¿ç•™ **7 å¤©å·¦å³**ã€‚è¶…éé€™å€‹æ™‚é–“ï¼ŒLINE API æœƒå›å‚³ 404ï¼Œè¡¨ç¤ºæª”æ¡ˆå·²è¢«åˆªé™¤ã€‚ç³»çµ±æœƒè‡ªå‹•è·³éé€™äº›æª”æ¡ˆã€‚

### Q2: RLS æ”¿ç­–è¦æ€éº¼è¨­å®šï¼Ÿ

**A**: æœ€ç°¡å–®çš„æ–¹å¼æ˜¯å…è¨± `authenticated` ç”¨æˆ¶ä¸Šå‚³ï¼š

```sql
CREATE POLICY "Allow uploads"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'chat-files');
```

å¦‚æœæ¸¬è©¦æ™‚é‡åˆ°å•é¡Œï¼Œå¯ä»¥æš«æ™‚å…è¨± `public` ä¸Šå‚³ï¼ˆ**ä¸æ¨è–¦æ­£å¼ç’°å¢ƒ**ï¼‰ã€‚

### Q3: è¨ºæ–·å·¥å…·é¡¯ç¤ºã€Œä¸Šå‚³æ¸¬è©¦å¤±æ•—ã€æ€éº¼è¾¦ï¼Ÿ

**A**: é€šå¸¸æ˜¯ RLS æ”¿ç­–å•é¡Œï¼š

1. åˆ° Supabase Dashboard â†’ Storage â†’ chat-files â†’ Policies
2. ç¢ºèªæœ‰å…è¨±ä¸Šå‚³çš„æ”¿ç­–
3. å¦‚æœæ²’æœ‰ï¼Œæ–°å¢ä¸€å€‹æ”¿ç­–ï¼ˆåƒè€ƒä¸Šé¢çš„ SQLï¼‰
4. é‡æ–°åŸ·è¡Œè¨ºæ–·

### Q4: å›æº¯åŠŸèƒ½å¯ä»¥åŸ·è¡Œå¤šæ¬¡å—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†æ˜¯ï¼š
- å·²ç¶“æˆåŠŸä¸‹è¼‰çš„æª”æ¡ˆä¸æœƒé‡è¤‡è™•ç†ï¼ˆæœ‰ `file_url` çš„è¨Šæ¯æœƒè¢«è·³éï¼‰
- æ¯æ¬¡æœ€å¤šè™•ç† 500 å‰‡è¨Šæ¯
- å»ºè­°é–“éš”ä¸€æ®µæ™‚é–“å†åŸ·è¡Œï¼Œé¿å… LINE API rate limit

### Q5: å¦‚ä½•æŸ¥çœ‹è©³ç´°çš„éŒ¯èª¤è¨Šæ¯ï¼Ÿ

**A**:
1. ä¼ºæœå™¨æ—¥èªŒï¼ˆ`npm run dev` çµ‚ç«¯æ©Ÿè¼¸å‡ºï¼‰
2. è¨ºæ–·é é¢çš„éŒ¯èª¤å€å¡Š
3. å›æº¯çµæœçš„ã€ŒæŸ¥çœ‹éŒ¯èª¤è©³æƒ…ã€ä¸‹æ‹‰é¸å–®

---

## æŠ€è¡“ç´°ç¯€

### æª”æ¡ˆå„²å­˜æµç¨‹

```
LINE ç¾¤çµ„è¨Šæ¯
    â†“
Webhook æ¥æ”¶ (/api/messaging/webhook)
    â†“
åˆ¤æ–·è¨Šæ¯é¡å‹ (image/video/audio/file)
    â†“
å¾ LINE API ä¸‹è¼‰æª”æ¡ˆ
    â†“
ä¸Šå‚³åˆ° Supabase Storage (chat-files bucket)
    â†“
å„²å­˜ file_url åˆ° line_messages è¡¨
    â†“
åŒæ™‚è¨˜éŒ„åˆ° line_files è¡¨
```

### ç›¸é—œæª”æ¡ˆ

| æª”æ¡ˆ | åŠŸèƒ½ |
|------|------|
| `pages/api/messaging/webhook.js` | LINE Webhookï¼ˆå«æª”æ¡ˆä¸‹è¼‰é‚è¼¯ï¼‰|
| `pages/api/storage/check.js` | Storage è¨ºæ–· API |
| `pages/api/storage/backfill.js` | æª”æ¡ˆå›æº¯ API |
| `pages/storage-check.js` | è¨ºæ–·é é¢ |

### è³‡æ–™åº«è¡¨

| è¡¨ | æ¬„ä½ |
|---|------|
| `line_messages` | `file_url`, `file_name`, `file_size` |
| `line_files` | æª”æ¡ˆè¨˜éŒ„ï¼ˆåŒ…å« prospect_id, project_idï¼‰ |

---

## è¯çµ¡æ”¯æ´

å¦‚æœé‡åˆ°ç„¡æ³•è§£æ±ºçš„å•é¡Œï¼Œè«‹æä¾›ï¼š

1. è¨ºæ–·å·¥å…·çš„æˆªåœ–
2. ä¼ºæœå™¨æ—¥èªŒï¼ˆæœ‰ âŒ ç¬¦è™Ÿçš„éŒ¯èª¤è¨Šæ¯ï¼‰
3. å•é¡Œç™¼ç”Ÿçš„æ™‚é–“å’Œç¾¤çµ„

---

**æœ€å¾Œæ›´æ–°**: 2025-01-07
